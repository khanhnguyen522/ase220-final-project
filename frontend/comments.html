<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/cities.css" />
    <link rel="stylesheet" href="/places.css" />
    <title>Comments</title>
  </head>
  <body>
    <div class="makeItFixed">
      <nav class="navbar nav-pills justify-content-around bg-light">
        <a class="navbar-brand fs-2 fw-semibold" href="#"
          >Comments <span id="countrycountry_name"></span
        ></a>
        <div class="auth-container d-flex gap-4 align-items-center w-20"></div>
      </nav>
    </div>
    <div class="d-flex justify-content-center">
      <div class="container mx-lg-5 mx-3 my-3">
        <div class="text-end">
          <a
            data-bs-toggle="modal"
            data-bs-target="#add_modal"
            class="btn bg-black text-white me-2 m-3"
            id="btn-add"
            >Add Comment</a
          >
        </div>
        <div
          id="comments-container"
          class="row row-cols-10 col-9 mx-auto"
        ></div>
      </div>
    </div>
    <div
      class="modal fade"
      id="add_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Add Your Comment
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card-body d-flex flex-column">
              <form>
                <div class="mb-3">
                  <textarea
                    class="form-control"
                    id="commentAdd"
                    rows="3"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="add-submit"
              class="btn bg-black text-white"
            >
              Add Comment
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="reply_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Add Your Reply
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card-body d-flex flex-column">
              <form>
                <div class="mb-3">
                  <textarea
                    class="form-control"
                    id="replyAdd"
                    rows="3"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              id="reply-submit"
              class="btn bg-black text-white"
            >
              Reply
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Login --------------------------------------------------------------->
    <div
      class="modal fade"
      id="login_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              <div class="d-flex">
                <h5>Log in</h5>
              </div>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form class="row g-3">
              <div class="col-12">
                <label for="loginEmail" class="form-label">Email address</label>
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  required
                />
              </div>
              <div class="col-12">
                <label for="loginPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  required
                />
              </div>
              <div class="col-12">
                <button class="btn btn-primary" type="submit">Login</button>
                <button
                  type="button"
                  class="btn btn-secondary signup-btn"
                  id="signup-btn"
                  data-bs-dismiss="modal"
                >
                  Don't have an account yet? Sign up
                </button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Signup--------------------------------------------------------------->
    <div
      class="modal fade"
      id="signup_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              <div class="d-flex">
                <h5>Sign Up</h5>
              </div>
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form class="row g-3">
              <div class="col-12">
                <label for="signupUsername" class="form-label">Your name</label>
                <input
                  type="text"
                  class="form-control"
                  id="signupUsername"
                  required
                />
              </div>
              <div class="col-12">
                <label for="signupEmail" class="form-label"
                  >Email address</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="signupEmail"
                  required
                />
              </div>
              <div class="col-12">
                <label for="signupPassword" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="signupPassword"
                  required
                />
              </div>
              <div class="col-12">
                <button class="btn btn-primary signup-submit-btn" type="submit">
                  Sign Up
                </button>
                <button
                  type="button"
                  class="btn btn-secondary login-btn"
                  id="login-btn"
                  data-bs-dismiss="modal"
                >
                  Already have an account? Login
                </button>
              </div>
              <div class="signupError"></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://kit.fontawesome.com/118e30abce.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      let comments = [];
      let replies = [];
      let users = [];

      const path = window.location.pathname;
      const pathParts = path.split("/");
      const placeId = pathParts[2];

      axios
        .get("http://localhost:8000/v1/user/all", {})
        .then(function (res) {
          users = res.data;
          console.log(users);
        })
        .catch(function (err) {
          console.log(err);
        });

      axios
        .get(`http://localhost:8000/v1/places/${placeId}/comments`, {})
        .then(function (res) {
          comments = res.data;
          console.log(comments);
          displayComments(comments);
        })
        .catch(function (err) {
          console.log(err);
        });

      async function generateComment(comment) {
        let repliesHtml = "";
        try {
          const res = await axios.get(
            `http://localhost:8000/v1/comments/${comment._id}/replies`
          );
          const replies = res.data;
          if (replies && replies.length > 0) {
            for (let reply of replies) {
              repliesHtml += `
                <div style="margin-left: 50px;">
                    <div class="card mb-3 mx-auto d-flex flex-coul">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    <div class='d-flex gap-2'>
                                        <i class="bi bi-person-circle"></i>
                                        <h5 class="card-title">${
                                          reply.createdBy?.name || "Unknown"
                                        }</h5>
                                        <span class="card-title opacity-50">${
                                          reply.createdBy?.email || "No Email"
                                        }</span>
                                    </div>
                                </div>
                                <p class="card-text d-flex opacity-75 fs-6">
                                    ${reply.reply}</p>
                                </div>
                    </div>

                </div>`;
            }
          }
          const commentCard = `
            <div>
                <div class="card mb-3 mx-auto">
                <div class="card-body">
                    <div class='d-flex gap-2'>
                    <i class="bi bi-person-circle"></i>
                    <div class='d-flex gap-3'>
                        <h5 class="card-title">${
                          comment.createdBy?.name || "Anonymous"
                        }</h5>
                        <span class="card-title opacity-50">${
                          comment.createdBy?.email || "No Email"
                        }</span>
                    </div>
                    </div>
                    <p class="card-text d-flex opacity-75 fs-6">${
                      comment.comment
                    }</p>
                    <div class="d-flex align-items-center justify-content-between fs-8">
                        <a data-bs-toggle="modal" class="btn bg-black text-white reply-btn d-flex gap-1 fs-8" id="${
                          comment._id
                        }">
                            <i class="bi bi-reply-fill fs-8"></i> Reply
                        </a>

                    </div>
                </div>
                </div>
                <div class="replies">
                ${repliesHtml}
                </div>
            </div>`;
          return commentCard;
        } catch (err) {
          console.error("error fetching replies:", err);
        }
      }

      function displayComments(comments) {
        comments = comments.sort(
          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
        );
        console.log(comments);
        const commentsContainer = document.getElementById("comments-container");
        commentsContainer.innerHTML = "";
        comments.forEach(async (comment) => {
          const commentCard = await generateComment(comment);
          commentsContainer.innerHTML += commentCard;
        });
      }

      function checkUserInLocalStorage() {
        const user = localStorage.getItem("user");
        const authContainer = $(".auth-container");
        if (user) {
          const username = JSON.parse(user).name;
          authContainer.html(`
            <div>Hi, ${username}</div>
            <button class = "btn btn-dark"id="logoutBtn">Logout</button>
          `);
          $("#btn-add").show();
        } else {
          $("#btn-add").hide();
          authContainer.html(`
            <button class ="btn btn-dark" data-bs-toggle="modal" data-bs-target="#login_modal" id="loginBtn">Login</button>
            <button class = "btn btn-dark" data-bs-toggle="modal" data-bs-target="#signup_modal" id="signupBtn">Sign Up</button>
          `);
        }
      }

      function loginUser(email, password) {
        axios
          .post(
            "http://localhost:8000/v1/user/login",
            { email: email, password: password },
            { headers: { "Content-Type": "application/json" } }
          )
          .then((res) => {
            const { accessToken, name } = res.data;
            localStorage.setItem("user", JSON.stringify({ name, accessToken }));
            $("#login_modal").modal("hide");
            checkUserInLocalStorage();
          })
          .catch((err) => {
            console.log(err);
            $(".loginError").text("Invalid email or password.");
          });
      }

      function signupUser(username, email, password) {
        axios
          .post("http://localhost:8000/v1/user/", {
            name: username,
            email: email,
            password: password,
          })
          .then((res) => {
            const { name, accessToken } = res.data;
            localStorage.setItem("user", JSON.stringify({ name, accessToken }));
            $("#signup_modal").modal("hide");
            checkUserInLocalStorage();
          })
          .catch((err) => {
            console.log(err);
            $(".signupError").text("Error during registration. Try again.");
          });
      }
      function logoutUser() {
        const accessToken = JSON.parse(
          localStorage.getItem("user")
        ).accessToken;
        axios
          .post(
            "http://localhost:8000/v1/user/logout",
            {},
            {
              headers: {
                token: `Bearer ${accessToken}`,
              },
            }
          )
          .then((res) => {
            localStorage.removeItem("user");
            checkUserInLocalStorage();
          })
          .catch((err) => {
            console.log(err);
          });
      }

      function createComment(commentData) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.log("User not authenticated");
          return;
        }
        const accessToken = user.accessToken;
        axios
          .post(
            `http://localhost:8000/v1/places/${placeId}/comments`,
            commentData,
            {
              headers: {
                token: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
            }
          )
          .then((res) => {
            console.log("comment created: ", res.data);
            $("#add_modal").modal("hide");
            axios
              .get(`http://localhost:8000/v1/places/${placeId}/comments`, {
                headers: {
                  token: `Bearer ${accessToken}`,
                },
              })
              .then((response) => {
                comments = response.data;
                $("#comments-container").empty();
                console.log(comments);
                displayComments(comments);
              });
          });
      }

      function createReply(replyData, commentId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.log("User not authenticated");
          return;
        }
        const accessToken = user.accessToken;
        axios
          .post(
            `http://localhost:8000/v1/comments/${commentId}/replies`,
            replyData,
            {
              headers: {
                token: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
            }
          )
          .then((res) => {
            console.log("reply created: ", res.data);
            $("#reply_modal").modal("hide");
            $("#comments-container").empty();
            displayComments(comments);
          });
      }

      $(document).ready(function () {
        checkUserInLocalStorage();
        $(document).on("click", "#logoutBtn", function () {
          logoutUser();
        });

        $("#login_modal form").submit(function (e) {
          e.preventDefault();
          const email = $("#loginEmail").val();
          const password = $("#loginPassword").val();
          loginUser(email, password);
        });

        $("#signup_modal form").submit(function (e) {
          e.preventDefault();
          const username = $("#signupUsername").val();
          const email = $("#signupEmail").val();
          const password = $("#signupPassword").val();
          signupUser(username, email, password);
        });

        $(document).on("click", "#login-btn", function () {
          $("#signup_modal").modal("hide");
          $("#login_modal").modal("show");
        });

        $(document).on("click", "#signup-btn", function () {
          $("#signup_modal").modal("show");
          $("#login_modal").modal("hide");
        });
      });

      $(() => {
        //add comment - done
        $(document).on("click", "#add-submit", function () {
          var commentData = {
            comment: $("#commentAdd").val(),
          };
          createComment(commentData);
        });
      });

      $(document).on("click", ".reply-btn", function () {
        const commentId = $(this).attr("id");
        $("#reply_modal").data("commentId", commentId);
        $("#reply_modal").modal("show");
      });

      //add reply
      $(document).on("click", "#reply-submit", function () {
        const commentId = $("#reply_modal").data("commentId");
        var replyData = {
          reply: $("#replyAdd").val(),
        };
        createReply(replyData, commentId);
      });
    </script>
  </body>
</html>

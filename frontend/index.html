
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta country_name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
  <link rel="stylesheet" href="cities.css">
  <title> Country</title>
</head>
<body>
  <div class="makeItFixed">
      <nav
         class="nav-bar bg-success p-2 font-monospace d-flex "
         style="--bs-bg-opaCountry: 0.5"
      >
       <div class="container-fluid" id="">
       <a class=" navbar-brand fs-2 fw-semibold" href="#">Country <span id="countrycountry_name"></span></a>
       </div>
       <div class="auth-container d-flex gap-5 align-items-center w-25"></div>
     </nav>

      <div
       class="d-flex justify-content-center mt-4 fw-semibold fs-2 pt-3 font-monospace"
      >
      <i class="fas fa-seedling" ></i> Explore the Colors of Culture: A World of Diversity Awaits <i class="fas fa-seedling"></i>
  </div>
</div>  
  <div class="d-flex justify-content-center font-monospace">
    <div class="container text-cente m-5">
      <div class = "container text-end m-3">
          <nav class="navbar bg-body-tertiary sticky-top">
              <div class="container-fluid">
                <form class="d-flex" role="search">
                  <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                  <button class="btn btn-outline-success" type="submit">
                      <i class="fas fa-search"></i> 
                  </button>
                </form>
                <!-- Button Links -->
                <div class="text-end">
                  <a data-bs-toggle="modal" data-bs-target="#add_modal" class="btn btn-dark me-2" id="btn-add">Add Country</a>
                  <a class="btn btn-dark" id="btn-favorite">Favorites</a>
                </div>
              </div>
            </nav>
            
      <div
        id="country-container"
        class="row row-cols-1 row-cols-sm-2 row-cols-lg-3"
      ></div>

      <!-- PAGINATION -------------------------------------------------------------------->
      <div id="actions" class="d-flex justify-content-center my-4"></div>
    </div>

    <!-- Login --------------------------------------------------------------->
   <div class="modal fade" id="login_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title fs-5" id="staticBackdropLabel">
        <div class="d-flex">
          <h5>Log in</h5>
        </div>
      </h1>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form class="row g-3">
        <div class="col-12">
          <label for="loginEmail" class="form-label">Email address</label>
          <input type="email" class="form-control" id="loginEmail" required>
        </div>
        <div class="col-12">
          <label for="loginPassword" class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" required>
        </div>
        
        <div class="col-12">
          <button class="btn btn-primary login-submit-btn" type="submit">Login</button>
          <button type="button" class="btn btn-secondary signup-btn" id="signup-btn" data-bs-dismiss="modal">Don't have an account yet? Sign up</button>
        </div>
        <div class="loginError"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
</div>
</div>

<!-- Signup--------------------------------------------------------------->
   <div class="modal fade" id="signup_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
  <div class="modal-content">
    <div class="modal-header">
      <h1 class="modal-title fs-5" id="staticBackdropLabel">
        <div class="d-flex">
          <h5>Sign Up</h5>
        </div>
      </h1>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <form class="row g-3">
         <div class="col-12">
          <label for="signupUsername" class="form-label">Your name</label>
          <input type="text" class="form-control" id="signupUsername" required>
        </div>
        <div class="col-12">
          <label for="signupEmail" class="form-label">Email address</label>
          <input type="email" class="form-control" id="signupEmail" required>
        </div>
        <div class="col-12">
          <label for="signupPassword" class="form-label">Password</label>
          <input type="password" class="form-control" id="signupPassword" required>
        </div>
        
        <div class="col-12">
          <button class="btn btn-primary signup-submit-btn" type="submit">Sign Up</button>
          <button type="button" class="btn btn-secondary login-btn" id="login-btn" data-bs-dismiss="modal">Already have an account? Login</button>
        </div>
         <div class="signupError"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
    </div>
  </div>
</div>
</div>

    <!--UPDATE MODAL ------------------------------------------------------->
    <div
      class="modal fade"
      id="update_modal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <!--Modal Header-->
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">
              Update Country
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card-body d-flex flex-column">
              <form>
                <div class="mb-3">
                  <label for="inputcountry" class="form-label">Country Name</label>
                  <input type="text" class="form-control" id="inputcountry"/>
                </div>

                <div class="mb-3">
                  <label for="inputRating" class="form-label">Ratings</label>
                  <input type="text" class="form-control" id="inputRating" />
                </div>
                <div class="mb-3">
                  <label for="inputDescription" class="form-label"
                    >Short Introduction</label
                  >
                  <textarea
                    class="form-control"
                    id="inputDescription"
                    rows="3"
                  ></textarea>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="edit-submit" class="btn btn-dark">
              Save changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!--Add Modal-->
    <div
    class="modal fade"
    id="add_modal"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
    tabindex="-1"
    aria-labelledby="staticBackdropLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">
            Add Your Favorite Country besides this listed-Country
          </h1>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="card-body d-flex flex-column">
            <form>
              <div class="mb-3">
                  <label for="inputImage" class="form-label">Country Image</label>
                  <input type="text" class="form-control" id="inputImageAdd" />
                </div>
              <div class="mb-3">
                <label for="inputcountry" class="form-label">Country Name</label>
                <input type="text" class="form-control" id="inputcountryAdd"/>
              </div>

            
              <div class="mb-3">
                <label for="inputRating" class="form-label">Ratings</label>
                <input type="text" class="form-control" id="inputRatingAdd" />
              </div>
              <div class="mb-3">
                <label for="inputDescription" class="form-label"
                  >Short Introduction</label
                >
                <textarea
                  class="form-control"
                  id="inputDescriptionAdd"
                  rows="3"
                ></textarea>
              </div>
            </form>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="add-submit" class="btn btn-success">
            Add Country
          </button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
  ></script>

  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"
  ></script>

  <script src="https://kit.fontawesome.com/118e30abce.js" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
  
    var offset = 0;
    var rpp = 9;
    var pages = 0;
    var editingCountryId = -1;
    var addingCountryId = -1;

    let users = []
    let Countries = []

    axios
    .get('http://localhost:8000/v1/countries', {})
    .then(function(res){
        Countries = res.data
        console.log(Countries)
        displayCards(Countries);
        displayPageBasedPagination(Countries);
      }).catch(function(err){
        console.log(err)
      })

    axios
      .get('http://localhost:8000/v1/user/all', {})
      .then(function (res) {
        users = res.data;
        console.log(users)
      })
      .catch(function (err) {
        console.log(err);
      });

    function displayPageBasedPagination(Countries) {
        rpp = 9;
        pages = Math.ceil(Countries.length / rpp);
        document.querySelector("#actions").innerHTML = "";
        for (let i = 0; i < pages; i++) {
          let loadMoreButton = document.createElement("button");
          loadMoreButton.setAttribute("data-page", i + 1);
          loadMoreButton.classList.add("btn");
          loadMoreButton.classList.add("page-btn");

          if (i * rpp === offset) {
            loadMoreButton.classList.add("btn-dark");
            loadMoreButton.classList.add("disabled");
          } else {
            loadMoreButton.classList.add("btn-outline-success");
          }
          loadMoreButton.classList.add("m-1");
          loadMoreButton.innerText = i + 1;
          loadMoreButton.addEventListener("click", function (e) {
            let buttons = document.querySelectorAll(".page-btn");
            for (let i = 0; i < buttons.length; i++) {
              buttons[i].classList.remove("disabled");
              buttons[i].classList.remove("btn-dark");
              buttons[i].classList.add("btn-outline-success");
            }
            offset = i * rpp;
            e.target.classList.remove("btn-outline-success");
            e.target.classList.add("btn-dark");
            e.target.classList.add("disabled");
            document.getElementById("country-container").innerHTML = "";
            displayCards(Countries);
          });
          document.querySelector("#actions").append(loadMoreButton);
        }
      }

      function generateCard(Country) {
          const cardHTML = `
          <div class="col cards my-2" id = ${Country._id}>
              <span class="card h-100">
                <div class="position-relative">
                  <img id="avatar" src="${Country.avatar}" class="card-img-top" alt="beagle" />
                </div>
                <div class="card-body d-flex flex-column" style="text-align: left;">
                  <div class="d-flex justify-content-between">
                  <div class="d-flex"> <h5  class="card-title fw-bold " style="font-size: 24px;">${Country.country}</h5>
                    </div>
                  <div>
                    <i class="fa-solid fa-star " ></i> ${Country.ratings}
                    </div>
                  </div>
                  <ul class="list-unstyled">
      
                    <li>${Country.message}</li>
                  </ul>
                </div>
                <div class="d-flex justify-content-end gap-2 m-3">
                  <a href="cities.html">
                      <button class="learn-more">
                        <span class="circle" aria-hidden="true">
                          <span class="icon arrow"></span>
                        </span>
                        <a class="button-text" href="/countries/${Country._id}/cities" >Explore</a>
                      </button>
                      </a>
                  <a data-bs-toggle="modal" data-bs-target="#update_modal"
                  class="btn btn-success" id="btn-edit">
                  <i class="bi bi-pencil-square"></i></a>
                  <a
                  class="btn btn-delete btn-dark d-flex align-items-center">
                  <i class="bi bi-trash3-fill"></i></a>
                </div>
              </span>
          </div>`;
        return cardHTML;
      }

      function displayCards(Countries) {
        for (let i = offset; i < Math.min(offset + rpp, Countries.length); i++) {
          document.getElementById("country-container").innerHTML += generateCard(
            Countries[i]
          );
        }
      }

      $(document).ready(function(){
          document.addEventListener('DOMContentLoaded', function () {
          var exploreButtons = document.querySelectorAll('.button-text');
          exploreButtons.forEach(function(button) {
            button.addEventListener('click', function() {
              var countryId = this.getAttribute('data-country-id');
              redirectToCities(countryId);
            });
          });
      });

      function redirectToCities(countryId) {
        window.location.href = `/countries/:${countryId}/cities`;
      }

      function populateUpdateModal(Country) {
        document.getElementById("inputcountry").value = Country.country;
        document.getElementById("inputRating").value = Country.ratings;
        document.getElementById("inputDescription").value = Country.message;
        document.getElementById("inputAge").value = Country.id;

      }
        
      function getCountryById(id) {
        return Countries.find((Country) => Country._id === id);
      }

      //done
      $(document).ready(function() {
        checkUserInLocalStorage();
        $(document).on('click', '#logoutBtn', function() {
            logoutUser()
        });

        $('#login_modal form').submit(function(e){
          e.preventDefault();
          const email = $('#loginEmail').val();
          const password = $('#loginPassword').val();
          loginUser(email, password)
        })

        $('#signup_modal form').submit(function(e){
          e.preventDefault();
          const username = $('#signupUsername').val()
          const email = $('#signupEmail').val();
          const password = $('#signupPassword').val();
          signupUser(username, email, password);
        })

        $(document).on("click", "#login-btn", function () {
          $("#signup_modal").modal("hide");
          $("#login_modal").modal("show");
        });

        $(document).on("click", "#signup-btn", function () {
            $("#signup_modal").modal("show");
            $("#login_modal").modal("hide");
        });

      });

      //done
      function loginUser(email, password){
        axios.post("http://localhost:8000/v1/user/login", {email: email, password: password},  {headers: { "Content-Type": "application/json" }}).then((res)=> {
            const {accessToken, name} = res.data
            localStorage.setItem('user', JSON.stringify({name, accessToken}))
            $("#login_modal").modal("hide");
            checkUserInLocalStorage();
        }).catch((err)=> {
            console.log(err)
            $(".loginError").text("Invalid email or password.");

        })
      }

      //done
      function signupUser(username, email, password){
        axios.post("http://localhost:8000/v1/user/", {
            name: username, email, password,
        }).then((res)=> {
            const {name, accessToken} = res.data;
            localStorage.setItem('user', JSON.stringify({name, accessToken}))
            $("#signup_modal").modal("hide");
            checkUserInLocalStorage();
        }).catch((err)=> {
            console.log(err)
            $(".signupError").text("Error during registration. Try again.");

        })
      }

      //done
      function logoutUser(){
        console.log('hi')
        const accessToken =JSON.parse(localStorage.getItem('user')).accessToken
        axios.post("http://localhost:8000/v1/user/logout",{}, {
            headers: {
            token: `Bearer ${accessToken}`, 
            },} 
        ).then((res)=> {
            localStorage.removeItem('user')
            checkUserInLocalStorage();
        }).catch((err)=> {
            console.log(err)
        })
      }

      function checkUserInLocalStorage(){
        const user = localStorage.getItem('user')
        const navbar = $('.nav-bar')
        const authContainer = navbar.find('.auth-container')
        if(user){
          const username = JSON.parse(user).name;
          authContainer.html(`
          <div>Hi, ${username}</div>
          <button id="logoutBtn">Logout</button>
          `)
        }else{
          authContainer.html(`
            <button data-bs-toggle="modal" data-bs-target="#login_modal" id="loginBtn">Login</button>
          <button data-bs-toggle="modal" data-bs-target="#signup_modal" id="signupBtn">Sign Up</button>
          `)
        }
      }

      //have to test later
      function deleteCountry(countryId){
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
            console.log("User not authenticated");
            return;
        }

        const accessToken = user.accessToken
        axios.delete(`http://localhost:8000/v1/countries/${countryId}`,  {
            headers: {
                Authorization: `Bearer ${accessToken}`, 
            },
        }).then((res)=> {
            console.log(res.data);
        })
      }

    
        $(() => {
        //DELETE------------------------------------have to test later
          $(document).on("click", ".btn-delete", function () {
            let parentDiv = $(this).parent().parent().parent();
            let countryId = parentDiv.attr("id");
            if (countryId) {
              deleteCountry(countryId)
              $("#country-container").empty();
              displayCards(Countries);
              displayPageBasedPagination(Countries);
            }
          });

          //POPULATE UPDATE - DONE
          $(document).on("click", "#btn-edit", function () {
            editingCountryId = ($(this).parents().parents().eq(1).attr('id'))
            const editingCountry = getCountryById(editingCountryId);
            populateUpdateModal(editingCountry);
          });

          //UPDATE-----------------------------------------
          $(document).on("click", "#edit-submit", function () {
            const editingCountry = getCountriesById(editingCountryId);
            var updatedCountry = {
              id: editingCountry.id,
              avatar: editingCountry.avatar,
              country: $("#inputcountry").val() || editingCountry.country,
              ratings: $("#inputRating").val() || editingCountry.ratings,
              message: $("#inputDescription").val() || editingCountry.message,
              cities: editingCountry.cities || []
            };

            const index = Countries.findIndex((Country) => Country.id === editingCountryId);
            if (index !== -1) {
              Countries[index] = updatedCountry;
            $("#country-container").empty();
            displayCards(Countries);
            }
            $("#update_modal").modal("hide");
            $.ajax({
                      type: "PUT",
                      url: `${url}/api/blobs/${id}`,
                      data: JSON.stringify(Countries),
                      contentType: "application/json; charset=utf-8",
                      dataType: "json",
                    success: function(xhr,data,response){   
                          axios
                            .get(`${url}/api/blobs/${id}`, {})
                            .then(function(res){
                                Countries = res.data.content
                                console.log(Countries)
                                displayCards(Countries);
                                displayPageBasedPagination(Countries);
                                
                              }).catch(function(err){
                                console.log(err)
                              })
                      },
                      error: function(errMsg) {
                          alert(errMsg);
                      }
                    });
          });

          //CREATE COUNTRY
          $(document).on("click", "#add-submit", function () {
            var addingCountry = {
              id: generateUniqueId(),
              avatar: $("#inputImageAdd").val(),
              country: $("#inputcountryAdd").val(),
              ratings: $("#inputRatingAdd").val(),
              message: $("#inputDescriptionAdd").val(),
              cities: [],
                       
            };
            Countries.unshift(addingCountry);
            $.ajax({
                      type: "PUT",
                      url: `${url}/api/blobs/${id}`,
                      data: JSON.stringify(Countries),
                      contentType: "application/json; charset=utf-8",
                      dataType: "json",
                      success: function(xhr,data,response){
                            axios
                            .get(`${url}/api/blobs/${id}`, {})
                            .then(function(res){
                                Countries = res.data.content
                                console.log(Countries)
                                displayCards(Countries);
                                displayPageBasedPagination(Countries);
                                
                              }).catch(function(err){
                                console.log(err)
                              })
                        },
                        error: function(errMsg) {
                            alert(errMsg);
                        }
                    });
                        
              });
            });
          });
    </script>
  </body>
</html>